<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LivingNotes - Make Your Docs Funny!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .tagline {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 500;
            display: none;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            min-width: 200px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            box-shadow: 0 10px 20px rgba(108, 117, 125, 0.3);
        }

        .features {
            margin-top: 30px;
            text-align: left;
        }

        .feature {
            display: flex;
            align-items: center;
            margin: 15px 0;
            color: #555;
        }

        .feature-icon {
            width: 20px;
            height: 20px;
            background: #667eea;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .preview {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: left;
            display: none;
        }

        .preview h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .preview-content {
            font-family: monospace;
            white-space: pre-wrap;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">🎭 LivingNotes</div>
        <div class="tagline">Transform your Google Docs into comedy gold!</div>
        
        <div id="status" class="status">
            <span id="statusText">Ready to connect to Google Docs</span>
        </div>

        <button id="connectBtn" class="btn secondary">
            Connect Google Docs
        </button>

        <button id="enhanceBtn" class="btn" disabled>
            🎪 Make My Doc Funny!
        </button>

        <button id="listDocsBtn" class="btn secondary" disabled>
            📋 List My Google Docs
        </button>

        <button id="checkStatusBtn" class="btn secondary" style="margin-top: 10px;">
            🔄 Check Connection Status
        </button>

        <div id="preview" class="preview">
            <h4>Preview of Enhanced Content:</h4>
            <div id="previewContent" class="preview-content"></div>
        </div>

        <div class="features">
            <div class="feature">
                <div class="feature-icon">✨</div>
                <span>Add witty comments and humor to your content</span>
            </div>
            <div class="feature">
                <div class="feature-icon">🎯</div>
                <span>Keep your original content intact</span>
            </div>
            <div class="feature">
                <div class="feature-icon">⚡</div>
                <span>Instant enhancement with AI magic</span>
            </div>
        </div>
    </div>

    <script>
        class LivingNotesApp {
            constructor() {
                this.isConnected = false;
                this.init();
            }

            init() {
                this.connectBtn = document.getElementById('connectBtn');
                this.enhanceBtn = document.getElementById('enhanceBtn');
                this.listDocsBtn = document.getElementById('listDocsBtn');
                this.checkStatusBtn = document.getElementById('checkStatusBtn');
                this.status = document.getElementById('status');
                this.statusText = document.getElementById('statusText');
                this.preview = document.getElementById('preview');
                this.previewContent = document.getElementById('previewContent');

                this.connectBtn.addEventListener('click', () => this.connectGoogleDocs());
                this.enhanceBtn.addEventListener('click', () => this.enhanceDocument());
                this.listDocsBtn.addEventListener('click', () => this.listDocuments());
                this.checkStatusBtn.addEventListener('click', () => this.checkConnectionStatus());

                this.updateStatus('disconnected', 'Ready to connect to Google Docs');
            }

            updateStatus(type, message) {
                this.status.className = `status ${type}`;
                this.statusText.innerHTML = message;
                this.status.style.display = 'block';
            }

            showLoading(message) {
                this.updateStatus('loading', `<span class="loading-spinner"></span>${message}`);
            }

            async connectGoogleDocs() {
                try {
                    this.showLoading('Initiating Google Docs connection...');
                    this.connectBtn.disabled = true;

                    const response = await fetch('/api/connect', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        // Show OAuth2 redirect URL
                        this.updateStatus('loading', `🔗 Please visit this URL to authenticate: ${result.redirect_url}`);
                        
                        // Open the OAuth2 URL in a new window
                        window.open(result.redirect_url, '_blank', 'width=600,height=600');
                        
                        // Poll for connection completion
                        this.pollForConnection();
                    } else {
                        throw new Error(result.error || 'Failed to connect');
                    }
                } catch (error) {
                    console.error('Connection error:', error);
                    this.updateStatus('disconnected', `❌ Connection failed: ${error.message}`);
                    this.connectBtn.disabled = false;
                }
            }

            async pollForConnection() {
                const maxAttempts = 30; // 30 seconds
                let attempts = 0;
                
                const poll = async () => {
                    try {
                        const response = await fetch('/api/verify-connection', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });

                        const result = await response.json();
                        console.log('Poll result:', result); // Debug log
                        
                        if (result.success) {
                            this.isConnected = true;
                            this.updateStatus('connected', '✅ Connected to Google Docs!');
                            this.connectBtn.textContent = 'Connected';
                            this.enhanceBtn.disabled = false;
                            this.listDocsBtn.disabled = false;
                            return;
                        } else {
                            // Log the error for debugging
                            console.log('Connection not ready yet:', result.error || 'Unknown error');
                        }
                        
                        attempts++;
                        if (attempts < maxAttempts) {
                            this.updateStatus('loading', `⏳ Waiting for authentication... (${attempts}/${maxAttempts})`);
                            setTimeout(poll, 1000);
                        } else {
                            this.updateStatus('disconnected', '❌ Authentication timeout. Please try again.');
                            this.connectBtn.disabled = false;
                        }
                    } catch (error) {
                        console.error('Poll error:', error);
                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(poll, 1000);
                        } else {
                            this.updateStatus('disconnected', '❌ Authentication failed. Please try again.');
                            this.connectBtn.disabled = false;
                        }
                    }
                };
                
                poll();
            }

            async enhanceDocument() {
                try {
                    this.showLoading('Making your document funny...');
                    this.enhanceBtn.disabled = true;

                    const response = await fetch('/api/enhance', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.updateStatus('connected', '🎉 Your document is now funnier!');
                        this.showPreview(result.original_content, result.enhanced_content);
                    } else {
                        throw new Error(result.error || 'Enhancement failed');
                    }
                } catch (error) {
                    console.error('Enhancement error:', error);
                    this.updateStatus('disconnected', `❌ Enhancement failed: ${error.message}`);
                } finally {
                    this.enhanceBtn.disabled = false;
                }
            }

            showPreview(original, enhanced) {
                this.previewContent.textContent = enhanced;
                this.preview.style.display = 'block';
            }

            async listDocuments() {
                try {
                    this.showLoading('Fetching your Google Docs...');
                    this.listDocsBtn.disabled = true;

                    const response = await fetch('/api/list-docs', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.updateStatus('connected', `📋 Found ${result.count} Google Docs!`);
                        this.showDocumentsList(result.documents);
                    } else {
                        throw new Error(result.error || 'Failed to list documents');
                    }
                } catch (error) {
                    console.error('List documents error:', error);
                    this.updateStatus('disconnected', `❌ Failed to list documents: ${error.message}`);
                } finally {
                    this.listDocsBtn.disabled = false;
                }
            }

            showDocumentsList(documents) {
                let content = '📋 Your Google Docs:\n\n';
                
                if (documents.length === 0) {
                    content += 'No documents found.';
                } else {
                    documents.forEach((doc, index) => {
                        content += `${index + 1}. ${doc.title}\n`;
                        content += `   ID: ${doc.id}\n`;
                        if (doc.modified) {
                            content += `   Modified: ${new Date(doc.modified).toLocaleDateString()}\n`;
                        }
                        content += '\n';
                    });
                }
                
                this.previewContent.textContent = content;
                this.preview.style.display = 'block';
            }

            async checkConnectionStatus() {
                try {
                    this.showLoading('Checking connection status...');
                    
                    const response = await fetch('/api/status', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();
                    console.log('Status check result:', result);
                    
                    if (result.connected) {
                        this.isConnected = true;
                        this.updateStatus('connected', '✅ Connected to Google Docs!');
                        this.connectBtn.textContent = 'Connected';
                        this.enhanceBtn.disabled = false;
                        this.listDocsBtn.disabled = false;
                    } else {
                        this.updateStatus('disconnected', '❌ Not connected to Google Docs');
                        this.connectBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('Status check error:', error);
                    this.updateStatus('disconnected', `❌ Status check failed: ${error.message}`);
                }
            }
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new LivingNotesApp();
        });
    </script>
</body>
</html>
